From: "Rémi Bernon" <rbernon@codeweavers.com>
Subject: [PATCH vkd3d] vkd3d: Clamp buffer image copy size to subresource dimensions.
Message-Id: <20191024195402.15779-1-rbernon@codeweavers.com>
Date: Thu, 24 Oct 2019 21:54:02 +0200

This fixes a vulkan validation error.

Signed-off-by: Rémi Bernon <rbernon@codeweavers.com>
---
 libs/vkd3d/command.c | 19 +++++++++++++------
 1 file changed, 13 insertions(+), 6 deletions(-)

diff --git a/libs/vkd3d/command.c b/libs/vkd3d/command.c
index 59ea4829..bb530093 100644
--- a/libs/vkd3d/command.c
+++ b/libs/vkd3d/command.c
@@ -3076,17 +3076,24 @@ static void vk_buffer_image_copy_from_d3d12(VkBufferImageCopy *copy,
     copy->imageOffset.x = dst_x;
     copy->imageOffset.y = dst_y;
     copy->imageOffset.z = dst_z;
+
+    vk_extent_3d_from_d3d12_miplevel(&copy->imageExtent, image_desc,
+            copy->imageSubresource.mipLevel);
+    copy->imageExtent.width -= copy->imageOffset.x;
+    copy->imageExtent.height -= copy->imageOffset.y;
+    copy->imageExtent.depth -= copy->imageOffset.z;
+
     if (src_box)
     {
-        copy->imageExtent.width = src_box->right - src_box->left;
-        copy->imageExtent.height = src_box->bottom - src_box->top;
-        copy->imageExtent.depth = src_box->back - src_box->front;
+        copy->imageExtent.width = min(copy->imageExtent.width, src_box->right - src_box->left);
+        copy->imageExtent.height = min(copy->imageExtent.height, src_box->bottom - src_box->top);
+        copy->imageExtent.depth = min(copy->imageExtent.depth, src_box->back - src_box->front);
     }
     else
     {
-        copy->imageExtent.width = footprint->Footprint.Width;
-        copy->imageExtent.height = footprint->Footprint.Height;
-        copy->imageExtent.depth = footprint->Footprint.Depth;
+        copy->imageExtent.width = min(copy->imageExtent.width, footprint->Footprint.Width);
+        copy->imageExtent.height = min(copy->imageExtent.height, footprint->Footprint.Height);
+        copy->imageExtent.depth = min(copy->imageExtent.depth, footprint->Footprint.Depth);
     }
 }

--
2.24.0.rc0

